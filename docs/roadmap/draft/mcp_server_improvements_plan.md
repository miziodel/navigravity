# Navigravity MCP: Unified technical Improvements (v3+)

Consolidated plan merging the "Technical Improvements Report (v3)" with the "Roadmap Strategy Draft".

## User Review Required

> [!IMPORTANT]
> - **Similar Tracks**: `similar_tracks_by_fingerprint` will act as a high-level wrapper. Internally, it will leverage Subsonic's `getSimilarSongs2` (or similar ID-based lookups) while exposing a clean, domain-specific interface to the Agent, hiding the underlying API implementation details.
> - **Tag Search**: `search_by_tag` will map to Navidrome's Genre system (which is how tags are mostly exposed in Subsonic API).

## 5. Advanced Rediscovery Architecture
**Problem**: The current `rediscover` mode (random song sampling) has a very low yield (~2%) due to Navidrome's 500-track limit on random fetches combined with strict criteria.

**Proposed Solution**: Implement a tiered discovery system:
- **Mode: `rediscover` (Default/Album Archeology)**: Shift from random *songs* to random *albums* (`getAlbumList2(type='random')`). This provides a coherent pool of tracks with higher yield.
- **Mode: `rediscover_deep` (Mining Loop)**: Implement an iterative fetch loop (max 10 passes) with duplicate detection to fulfill large limits using pure random sampling.
- **Mode: `fallen_pillars` (Top Artist Deep-Scan)**: Identify top artists and explicitly scan their discographies for "forgotten" (played > 1yr ago) or "hidden" (played 0) tracks.
- **Mode: `similar_to_starred` (Proximity Rediscovery)**: Use high-rated/starred tracks (which are easily fetched via `getStarred`) as seeds for the `getSimilarSongs` engine.

## 5. Internal API: Semantic Search Wrapper
**Problem**: The codebase currently calls `search3` directly in multiple places (or plan to do so), which is an implementation detail of the Subsonic API.
**Proposed Solution**:
- Implement `_fetch_search_results(query, song_count=None, album_count=None, artist_count=None)` internal helper.
- Abstract the `searchResult3` dictionary traversal and normalization (e.g., handling single vs list returns).
- Decouple tool logic from raw API response structures.

---
*Generated by Antigravity Agent*

## Proposed Changes

### MCP Server (`src/navidrome_mcp_server.py`)

- **[NEW] Tool: `batch_check_presence(artist_list: List[str])`**
    - Efficient O(1) lookup against full artist index.
- **[NEW] Tool: `search_by_tag(tags: List[str], logic: str = "OR")`**
    - Multi-genre intersection/union for "vibe" search.
- **[NEW] Tool: `get_similar_artists(artist_name: str, limit: int = 10)`**
    - From Roadmap: Finds bridge artists using Subsonic intelligence.
- **[NEW] Tool: `similar_tracks_by_fingerprint(track_id: str, limit: int = 20)`**
    - V3 Request: Uses `getSimilarSongs2` to find acoustically similar matches.
- **[NEW] Tool: `validate_playlist_rules(track_ids: List[str], rules: Dict)`**
    - V3 Request: Dry-run validation for diversity and mood.

- **[UPDATED] `assess_playlist_quality`**
    - Roadmap: Graceful degradation (skip missing IDs instead of failing).
- **[UPDATED] `get_smart_candidates`**
    - Roadmap: Multi-mode harvesting (e.g., `mode="hidden_gems,divergent"`).
    - **Rediscovery v2**: Implement `rediscover` (Album Archeology), `rediscover_deep` (Mining Loop), `fallen_pillars` (Top Artists), and `similar_to_starred` (Proximity).
- **[UPDATED] `get_genre_tracks`**
    - Roadmap: Batch genre handling (accepts list of genres).

- **[MISC] Version Bump**
    - Set `__version__ = "0.1.7"`.

## Verification Plan

### Automated Tests
Updated test suite in `tests/test_v3_unified.py`.

**Command:**
```bash
python tests/test_v3_unified.py
```

**Test Scenarios:**
1.  **Multi-Mode Harvesting**: Verify `get_smart_candidates` handles multiple modes and merges results.
2.  **Graceful Degradation**: Pass one invalid ID to `assess_playlist_quality` and verify it still returns results for valid IDs.
3.  **Efficiency Tools**: Verify `batch_check_presence` and `search_by_tag` logic.
4.  **Similarity Tools**: Verify `get_similar_artists` and `similar_tracks_by_fingerprint` return valid data.

### Manual Verification
- Inspect JSON logs to verify tool durations and result counts.

